<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Slack Thread Editor</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            height: 100vh;
        }

        .container {
            display: flex;
            flex: 1;
        }

        .input-section,
        .output-section {
            flex: 1;
            padding: 20px;
            box-sizing: border-box;
        }

        .input-section {
            border-right: 2px solid #ddd;
        }

        .output-section {
            /*background-color: #f9f9f9;*/
        }

        .editor {
            width: 100%;
            height: 90%;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 10px;
            font-size: 16px;
            box-shadow: 2px 2px 8px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .editor:focus {
            outline: none;
        }

        li img {
            width: 1em;
            /* Match text size */
            height: 1em;
            /* Ensure square aspect ratio */
            vertical-align: -0.2em;
            /* Adjust alignment slightly */
        }

        .output {
            padding: 10px;
            font-size: 16px;
            border-radius: 5px;
            box-shadow: 2px 2px 8px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body>
<div class="container">
    <div class="input-section">
        <h2>Rich Text Editor</h2>
        <div id="editor" class="editor" contenteditable="true" placeholder="Type something...">
            <div class="c-virtual_list__item">
                <div class="c-message_kit__background p-message_pane_message__message c-message_kit__message">
                    <div class="c-message_kit__hover">
                        <div class="c-message_kit__actions c-message_kit__actions--default">
                            <div class="c-message_kit__gutter">
                                <div class="c-message_kit__gutter__left"><span class="p-member_profile_hover_card"> <button
                                        class="c-button-unstyled c-message_kit__avatar c-avatar c-avatar--interactive"> <span
                                        class="c-base_icon__width_only_container"> <img
                                        src="https://ca.slack-edge.com/E01Q44F43U7-UKB1DLGBY-e53c18ba0452-48"
                                        class="c-base_icon c-base_icon--image"> </span> </button> </span></div>
                                <div class="c-message_kit__gutter__right"><span
                                        class="c-message__sender c-message_kit__sender"> <span class="p-member_profile_hover_card"> <button
                                        class="c-link--button c-message__sender_button">Ashley Kim</button> </span> <span
                                        class="offscreen">Ashley Kim</span> </span>&nbsp;&nbsp;<a class="c-link c-timestamp"
                                                                                                  href="https://squarespace.slack.com/archives/C078WKY7VUZ/p1738253162713079">
                                    <span class="c-timestamp__label">11:06 AM</span> </a> <br>
                                    <div class="c-message_kit__blocks c-message_kit__blocks--rich_text">
                                        <div class="c-message__message_blocks c-message__message_blocks--rich_text">
                                            <div class="p-block_kit_renderer">
                                                <div class="p-block_kit_renderer__block_wrapper p-block_kit_renderer__block_wrapper--first">
                                                    <div class="p-rich_text_block">
                                                        <div class="p-rich_text_section">sometimes that can mean that the PMs have
                                                            been uploaded to Stripe and we just&nbsp;haven’t&nbsp;received the
                                                            response yet&nbsp;<span class="c-emoji c-emoji__medium c-emoji--inline"> <img
                                                                    src="https://a.slack-edge.com/production-standard-emoji-assets/14.0/apple-medium/1f914@2x.png"> </span>
                                                            <br>if&nbsp;that’s&nbsp;the case, then it will probs cause some issues
                                                            in the migration pubsub if we rollback before that
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="c-virtual_list__item">
                <div class="c-message_kit__background p-message_pane_message__message c-message_kit__message">
                    <div class="c-message_kit__hover">
                        <div class="c-message_kit__actions c-message_kit__actions--above">
                            <div class="c-message_kit__gutter">
                                <div class="c-message_kit__gutter__left">
                                    <div class="p-message_pane_message__compact_timestamp p-message_pane_message__compact_timestamp--light p-message_pane_message__compact_timestamp--adjacent">
                                        <a class="c-link c-timestamp"
                                           href="https://squarespace.slack.com/archives/C078WKY7VUZ/p1738253236320199"> <span
                                                class="c-timestamp__label">11:07</span> </a></div>
                                </div>
                                <div class="c-message_kit__gutter__right"><span class="offscreen">Ashley Kim</span>
                                    <div class="c-message_kit__blocks c-message_kit__blocks--rich_text">
                                        <div class="c-message__message_blocks c-message__message_blocks--rich_text">
                                            <div class="p-block_kit_renderer">
                                                <div class="p-block_kit_renderer__block_wrapper p-block_kit_renderer__block_wrapper--first">
                                                    <div class="p-rich_text_block">
                                                        <div class="p-rich_text_section">the file usually uploads on thursday, so
                                                            maybe we can wait till EOD to see which action to take?
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="output-section">
        <h2>Formatted Output</h2>
        <div id="output" class="output">
        </div>
    </div>
</div>

<script>
    const editor = document.getElementById('editor');
    const output = document.getElementById('output');

    // Clear the editor when it's clicked again
    editor.addEventListener('click', () => {
        // editor.innerHTML = null;
        try {
            formatSlackInput();
        } catch (err) {
            console.log(err);
            output.innerText = err;
        }
    });

    // Format on input
    editor.addEventListener('input', () => {
        formatSlackInput();
        // output.innerText = "hi";
    });

    function removeQuickReactButtons() {
        // document.querySelectorAll('.c-message_actions__container').forEach(element => {
        //     element.remove(); // Removes the element from the DOM
        // });
        // document.querySelectorAll('.c-message__actions').forEach(element => {
        //     element.remove(); // Removes the element from the DOM
        // });
        document.querySelectorAll('c-message_actions__container c-message__actions').forEach(element =>
            element.remove()
        );
    }

    function formatSlackInput() {
        removeQuickReactButtons();
        // 1. Create a temporary div that copies editor html
        const tempDiv = document.createElement('div');
        // tempDiv.id = "tempDiv"
        // tempDiv.innerHTML = editor.innerHTML;
        // Convert each message list item to a list item or whatever it should be interpreted as
        // so each "c-virtual_list__item" will create a new li and append itself to the parent
        // then we keep travelling through the children, determining what to add or what to remove
        // 1. Create a temporary div that copies editor html
        const blankDiv = document.createElement('ul');
        Array.from(editor.children).forEach(child => {

            // processChildren(child)
            // output.innerText += child + "\n"
            // console.dir(child)
            blankDiv.append(...processChildren(child));
        });
        tempDiv.appendChild(blankDiv)
        // move through the children,
        // Set output div to be equal to temporary div
        output.innerHTML = tempDiv.innerHTML;
    }

    function processChildren(element) {
        // console.log("processing: " + element.className)
        let transformedNode = null;
        if (element.getAttribute("id") == "tempDiv") {
            transformedNode = document.createElement('div');
        }
        if (element.className == "c-virtual_list__item") {
            transformedNode = document.createElement('li');
            // console.log("this is a li:")
            // console.dir(element)
        }
        if (element.className == "c-link--button c-message__sender_button") {
            transformedNode = document.createElement("b");
            transformedNode.innerHTML = null;
            transformedNode.innerText = element.innerText;
            console.dir([transformedNode]);
            return [ transformedNode ];
        }
        if (element.className == "c-timestamp__label") {
            transformedNode = document.createElement("span");
            // transformedNode.innerHTML += " ";
            transformedNode.innerText = " " + element.innerText;
            transformedNode.innerText += ": ";
        }
        if (element.className == "p-rich_text_section") {
            // printToOutput(element.innerText);

            transformedNode = document.createElement('span');
            // const p = document.createElement("pp");
            // p.innerHTML = "<b>name </b>:";
            // transformedNode.appendChild( p)
            const br = document.createElement("br"); // Create the <br> element
            const t = document.createElement("t"); // Create the <t> element (though <t> is not a standard HTML tag)
            t.textContent = element.innerText; // Add text to <t>
            transformedNode.appendChild(br)
            transformedNode.appendChild(t)
            // transformedNode.appendChild(document.createElement('br'));
            // transformedNode.appendChild(document.createElement('t'));
            // transformedNode.innerText = element.innerText;
            // transformedNode.innerText = "fuuuuu";
            // output.innerText += element.innerText + "\n";
            // console.log("returning myself" + element.className)
            // console.dir([transformedNode])
            return [transformedNode];
        }
        if (transformedNode == null) {
            // console.log("no match for " + element.className)
        }
        if (transformedNode == null && element.children == null) {
            // output.innerText += element.className + " is the end, null and no children.\n";
            return [];
        }
        if (transformedNode != null) {
            if (transformedNode.tagName == "LI") {
                // console.log("this is a li:")
                // console.dir(element)
                // }
                // Array.from(element.children).forEach(child =>
                //     // const transformedChild = processChildren(child);
                //     appendChildrenToNode(processChildren(child))
                // );
                let chillen = Array.from(element.children).map(child => processChildren(child));
                // if (chillen != null || c.length != 0 ) {
                //     console.log("flat:");
                //     console.dir(chillen.flat())
                //     // return chillen.flat();
                // } else {
                //     console.log("no chillen worth processing");
                // }
                transformedNode.append(...chillen.flat());
            }
            // console.log("after all that")
            // console.dir([transformedNode])
            return [transformedNode];
        }
        if (transformedNode == null && element.children != null) {
            // console.log("has chillen tho " + element.className)
            // console.dir(element.children)
            let chillen = Array.from(element.children).map(child => processChildren(child));
            // console.log("processed:");
            // console.dir(chillen)
            if (chillen != null || c.length != 0 ) {
                // console.log("flat:");
                // console.dir(chillen.flat())
                return chillen.flat();
            } else {
                // console.log("no chillen worth processing");
            }

            // printToOutput(element.className + ":: is useless, but their children may not be");
            // if i am useless but my children are not useless, then return them as though they were myself
            // c = Array.from(element.children).map(child => {
            //     processChildren(child)
            // }).flat();
            // if (c != null || c.length != 0) {
            //     printToOutput(element.className + ":: WAS NOT USELESS SLAYY");
            // }
            // return c;
        }
        // const transformedChildren = Array.from(element.children).map(child => processChildren(child));

        return [];
        // return transformedNode;
    }

    // assuming children is an array
    function appendChildrenToNode(node, children) {
        if (children != null) {
            for (let child in children) {
                console.log("append this to the node")
                console.dir(child)
                node.appendChild(child);
            }
        }
        // if (children != null && children.length != 0) {
        //     printToOutput("i have children!" + children)
        //     node.append(...children);
        // }
    }

    function printToOutput(str) {
        output.innerText += str + "\n";
    }

</script>
</body>

</html>