<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Slack Thread Editor</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            height: 100vh;
        }

        .container {
            display: flex;
            flex: 1;
        }

        .input-section,
        .output-section {
            flex: 1;
            padding: 20px;
            box-sizing: border-box;
        }

        .input-section {
            border-right: 2px solid #ddd;
        }

        .output-section {
            /*background-color: #f9f9f9;*/
        }

        .editor {
            width: 100%;
            height: 90%;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 10px;
            font-size: 16px;
            box-shadow: 2px 2px 8px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .editor:focus {
            outline: none;
        }

        li img {
            width: 1em;
            /* Match text size */
            height: 1em;
            /* Ensure square aspect ratio */
            vertical-align: -0.2em;
            /* Adjust alignment slightly */
        }

        img {
            width: 1em;
            /* Match text size */
            height: 1em;
            /* Ensure square aspect ratio */
            vertical-align: -0.2em;
            /* Adjust alignment slightly */
        }

        .output {
            padding: 10px;
            font-size: 16px;
            border-radius: 5px;
            box-shadow: 2px 2px 8px rgba(0, 0, 0, 0.1);
        }


        .emoji-reaction {
            /*margin-left: 5px;*/
            margin-right: 10px;
        }

        .reaction-emoji-img {
            margin-right: 4px;
        }

        .emoij-reaction-count {
            font-size: 11px;
        }

    </style>
</head>
<body>
<div class="container">
    <div class="input-section">
        <h2>Rich Text Editor</h2>
        <div id="editor" class="editor" contenteditable="true" placeholder="Type something...">
            <div class="c-message_kit__reaction_bar c-reaction_bar c-reaction_bar--collapsed">
                            <span>
                                <button class="c-button-unstyled c-reaction c-reaction--light c-reaction--reacted">
                                    <img src="https://a.slack-edge.com/production-standard-emoji-assets/14.0/apple-small/1f970@2x.png" class="c-emoji c-emoji__small">
                                    <span class="c-reaction__count">
                                    </span>
                                </button>
                                <button class="c-button-unstyled c-reaction c-reaction--light c-reaction--reacted">
                                    <img src="https://a.slack-edge.com/production-standard-emoji-assets/14.0/apple-small/1f60d@2x.png" class="c-emoji c-emoji__small">
                                    <span class="c-reaction__count">
                                    </span>
                                </button>
                                <button class="c-button-unstyled c-reaction c-reaction--light c-reaction--reacted">
                                    <img src="https://emoji.slack-edge.com/T01Q44F43U7/aaaaaa/99689f7cf57cd5eb.gif" class="c-emoji c-emoji__small">
                                    <span class="c-reaction__count">
                                    </span>
                                </button>
                                <button class="c-button-unstyled c-reaction_add">
                                    <svg>
                                        <path class="c-reaction_add__bg">
                                        </path>
                                        <path class="c-reaction_add__fg">
                                        </path>
                                    </svg>
                                </button>
                            </span>
            </div>
        </div>
    </div>
    <div class="output-section">
        <h2>Formatted Output</h2>
        <div id="output" class="output">
        </div>
    </div>
</div>

<script>
    const editor = document.getElementById('editor');
    const output = document.getElementById('output');

    // Clear the editor when it's clicked again
    editor.addEventListener('click', () => {
        // editor.innerHTML = null;
        try {
            formatSlackInput();
        } catch (err) {
            console.log(err);
            output.innerText = err;
        }
    });

    // Format on input
    editor.addEventListener('input', () => {
        formatSlackInput();
        // output.innerText = "hi";
    });

    function cutDownTheElements() {
        // Create a temporary div to format the HTML
        const tempDiv = document.createElement("div");
        tempDiv.innerHTML = editor.innerHTML;

        // Step 3: Loop through each child element and update the 'top' style
        const elements = tempDiv.querySelectorAll('*');

        // Remove the quick emoji react buttons
        document.querySelectorAll('.c-message_actions__container').forEach(element => {
            element.remove(); // Removes the element from the DOM
        });
        document.querySelectorAll('.c-message__actions').forEach(element => {
            element.remove(); // Removes the element from the DOM
        });

        // Iterate through elements that weren't removed
        elements.forEach(element => {
            keepSpecificAttributes(element);
        });

        editor.innerHTML = tempDiv.innerHTML;
    }

    const ATTRIBUTES = ["class", "src", "href"];
    function keepSpecificAttributes(element) {
        // Loop through all attributes of the element
        for (let i = element.attributes.length - 1; i >= 0; i--) {
            const attr = element.attributes[i];

            // If the attribute name is not in the allowed list, remove it
            if (!ATTRIBUTES.includes(attr.name)) {
                element.removeAttribute(attr.name);
            }
        }
    }

    function removeQuickReactButtons() {
        // document.querySelectorAll('.c-message_actions__container').forEach(element => {
        //     element.remove(); // Removes the element from the DOM
        // });
        // document.querySelectorAll('.c-message__actions').forEach(element => {
        //     element.remove(); // Removes the element from the DOM
        // });
        document.querySelectorAll('c-message_actions__container c-message__actions').forEach(element =>
            element.remove()
        );
    }

    function formatSlackInput() {
        cutDownTheElements();
        removeQuickReactButtons();
        // 1. Create a temporary div that copies editor html
        const tempDiv = document.createElement('div');
        // tempDiv.id = "tempDiv"
        // tempDiv.innerHTML = editor.innerHTML;
        // Convert each message list item to a list item or whatever it should be interpreted as
        // so each "c-virtual_list__item" will create a new li and append itself to the parent
        // then we keep travelling through the children, determining what to add or what to remove
        // 1. Create a temporary div that copies editor html
        const blankDiv = document.createElement('ul');
        Array.from(editor.children).forEach(child => {

            // processChildren(child)
            // output.innerText += child + "\n"
            // console.dir(child)
            blankDiv.append(...processChildren(child));
        });
        tempDiv.appendChild(blankDiv)
        // move through the children,
        // Set output div to be equal to temporary div
        output.innerHTML = tempDiv.innerHTML;
    }

    function processNameLabel(element) {
        const name = document.createElement("b");
        name.innerText = element.innerText;
        return name;
    }

    function processTimestamp(element) {
        const timestamp = document.createElement("span");
        timestamp.innerText = " [" + element.innerText + "]: ";
        return timestamp;
    }

    function processChildren(element) {
        // console.log("processing: " + element.className)
        let transformedNode = null;
        if (element.getAttribute("id") == "tempDiv") {
            transformedNode = document.createElement('div');
        }
        if (element.className == "c-virtual_list__item") {
            transformedNode = document.createElement('li');
            // console.log("this is a li:")
            // console.dir(element)
        }
        // if (element.className == "c-button-unstyled c-reaction c-reaction--light") {
        //     transformedNode = document.createElement('span');
        //     transformedNode.className = "emoji-reaction-container"
        //     transformedNode.append(document.createElement('br'))
        //     transformedNode.append(document.createElement('t'))
        //     transformedNode.append(...element.children)
        //     // transformedNode.innerHTML = element.innerHTML
        // }
        if (element.classList.contains("c-message_kit__reaction_bar")) {
            console.dir(element)

            transformedNode = document.createElement('span');
            transformedNode.className = "emoji-reactions-container"
            transformedNode.append(document.createElement('br'))
            transformedNode.append(document.createElement('t'))
        }
        if (element.classList.contains("c-reaction_add")) {
            return [];
        }
        if (element.classList.contains("c-reaction")) {
            transformedNode = document.createElement('span');
            transformedNode.className = "emoji-reaction"
        }
        if (element.className == "c-emoji c-emoji__small" ) {
            transformedNode = document.createElement('img');
            transformedNode.src = element.src;
            transformedNode.className = "reaction-emoji-img"
        }
        if (element.className == "c-reaction__count") {
            transformedNode = document.createElement('span');
            transformedNode.className = "emoij-reaction-count"
            transformedNode.innerText = element.innerText;
        }
        if (element.className == "c-message_actions__group") {
            return [];
        }
        if (element.className == "c-link--button c-message__sender_button") {
            transformedNode = processNameLabel(element)
        }
        if (element.className == "c-timestamp__label") {
            transformedNode = processTimestamp(element)
        }
        if (element.className == "p-rich_text_list p-rich_text_list__ordered p-rich_text_list--nested") {
            transformedNode = document.createElement('ol');
        }
        if (element.className == "p-rich_text_list p-rich_text_list__bullet p-rich_text_list--nested") {
            transformedNode = document.createElement('ul');
        }
        if (element.tagName == "LI") {
            console.log('got in here')
            console.dir(element)
            transformedNode = document.createElement('li');
            transformedNode.innerHTML = element.innerHTML;
        }
        if (element.tagName == "OL") {
            console.log('isOL')
            console.dir(element)
            transformedNode = document.createElement('ol');
        }
        if (element.tagName == "UL") {
            transformedNode = document.createElement('ul');
        }
        if (element.className == "p-rich_text_section") {
            // console.dir(element)
            // for (let child in Array.from(element.children)) {
            //     // console.log(child.tagName)
            //     // console.log(child.tag)
            //     // console.dir(child)
            // }
            transformedNode = document.createElement('span');
            const br = document.createElement("br"); // Create the <br> element
            const t = document.createElement("t"); // Create the <t> element (though <t> is not a standard HTML tag)
            const message = document.createElement('span');
            message.innerHTML = element.innerHTML;
            transformedNode.appendChild(br)
            transformedNode.appendChild(t)
            transformedNode.appendChild(message)
            // transformedNode.appendChild(document.createElement('br'));
            // transformedNode.appendChild(document.createElement('t'));
            // transformedNode.innerText = element.innerText;
            // transformedNode.innerText = "fuuuuu";
            // output.innerText += element.innerText + "\n";
            // console.log("returning myself" + element.className)
            // console.dir([transformedNode])
            // return transformedNode;
        }
        if (transformedNode == null) {
            // console.log("no match for " + element.className)
        }
        if (transformedNode == null && element.children == null) {
            // output.innerText += element.className + " is the end, null and no children.\n";
            return [];
        }
        if (transformedNode != null) {
            // if (transformedNode.tagName == "LI") {
            //     // console.log("this is a li:")
            //     // console.dir(element)
            //     // }
            //     // Array.from(element.children).forEach(child =>
            //     //     // const transformedChild = processChildren(child);
            //     //     appendChildrenToNode(processChildren(child))
            //     // );
            //     let chillen = Array.from(element.children).map(child => processChildren(child));
            //     // if (chillen != null || c.length != 0 ) {
            //     //     console.log("flat:");
            //     //     console.dir(chillen.flat())
            //     //     // return chillen.flat();
            //     // } else {
            //     //     console.log("no chillen worth processing");
            //     // }
            //     transformedNode.append(...chillen.flat());
            // }
            transformedNode.append(...Array.from(element.children).map(child => processChildren(child)).flat())
            // console.log("after all that")
            // console.dir([transformedNode])
            return [transformedNode];
        }
        if (transformedNode == null && element.children != null) {
            // console.log("has chillen tho " + element.className)
            // console.dir(element.children)
            let chillen = Array.from(element.children).map(child => processChildren(child));
            // console.log("processed:");
            // console.dir(chillen)
            if (chillen != null || c.length != 0 ) {
                // console.log("flat:");
                // console.dir(chillen.flat())
                return chillen.flat();
            } else {
                // console.log("no chillen worth processing");
            }

            // printToOutput(element.className + ":: is useless, but their children may not be");
            // if i am useless but my children are not useless, then return them as though they were myself
            // c = Array.from(element.children).map(child => {
            //     processChildren(child)
            // }).flat();
            // if (c != null || c.length != 0) {
            //     printToOutput(element.className + ":: WAS NOT USELESS SLAYY");
            // }
            // return c;
        }
        // const transformedChildren = Array.from(element.children).map(child => processChildren(child));

        return [];
        // return transformedNode;
    }

    // assuming children is an array
    // function appendChildrenToNode(node, children) {
    //     if (children != null) {
    //         for (let child in children) {
    //             console.log("append this to the node")
    //             console.dir(child)
    //             node.appendChild(child);
    //         }
    //     }
    //     // if (children != null && children.length != 0) {
    //     //     printToOutput("i have children!" + children)
    //     //     node.append(...children);
    //     // }
    // }

    // function printToOutput(str) {
    //     output.innerText += str + "\n";
    // }

</script>
</body>

</html>